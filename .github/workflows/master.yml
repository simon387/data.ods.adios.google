name: 🚀 Deploy website on push

on:
  push:
    branches: [ master, main ]
  workflow_dispatch: # Permette esecuzione manuale

jobs:
  deploy:
    name: 🎉 Deploy to FTP
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: 🚚 Get latest code
        uses: actions/checkout@v4

      - name: 📋 List files to deploy
        run: |
          echo "Files that will be deployed:"
          find . -type f -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "*.php" -o -name "*.txt" | grep -v "/.git" | sort

      - name: 🔧 Setup deployment retry strategy
        id: deploy
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 5
          retry_wait_seconds: 30
          retry_on: error
          shell: bash
          command: |
            echo "🚀 Attempting FTP deployment (Attempt ${{ strategy.job-index + 1 }})"
            
            # Strategia 1: FTP Standard con IPv4 forzato
            if [ "${{ strategy.job-index }}" -eq "0" ]; then
              echo "📡 Trying standard FTP with IPv4"
              docker run --rm \
                -v ${{ github.workspace }}:/workspace \
                -e FTP_SERVER="${{ secrets.ftp_server }}" \
                -e FTP_USERNAME="${{ secrets.ftp_username }}" \
                -e FTP_PASSWORD="${{ secrets.ftp_password }}" \
                -e SERVER_DIR="x/" \
                samkirkland/ftp-deploy:latest \
                --server="${{ secrets.ftp_server }}" \
                --username="${{ secrets.ftp_username }}" \
                --password="${{ secrets.ftp_password }}" \
                --server-dir="x/" \
                --exclude="**/.git*,**/.git*/**,**/sql/**,README.md,Config.php" \
                --timeout=300000 \
                --log-level=verbose \
                --prefer-ipv4=true \
                --passive=true
            fi

      - name: 📂 Deploy with primary strategy
        if: steps.deploy.outcome != 'success'
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.ftp_server }}
          username: ${{ secrets.ftp_username }}
          password: ${{ secrets.ftp_password }}
          server-dir: x/
          timeout: 300000
          log-level: verbose
          prefer-ipv4: true
          passive: true
          exclude: |
            **/.git*
            **/.git*/**
            **/sql/**
            README.md
            Config.php
            .github/**
            .gitignore
            *.md

      - name: 📂 Fallback: Deploy with FTPS
        if: failure()
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.ftp_server }}
          username: ${{ secrets.ftp_username }}
          password: ${{ secrets.ftp_password }}
          protocol: ftps
          port: 21
          server-dir: x/
          timeout: 600000
          log-level: verbose
          security: loose
          exclude: |
            **/.git*
            **/.git*/**
            **/sql/**
            README.md
            Config.php
            .github/**

      - name: 📂 Ultimate fallback: SFTP Deploy
        if: failure()
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: ${{ secrets.ftp_server }}
          username: ${{ secrets.ftp_username }}
          password: ${{ secrets.ftp_password }}
          port: 22
          local_path: './'
          remote_path: '/x/'
          sftp_only: true
          args: '-o ConnectTimeout=5'

      - name: 🧹 Cleanup and verify
        if: success()
        run: |
          echo "✅ Deployment completed successfully!"
          echo "🔗 Files deployed to: ${{ secrets.ftp_server }}/x/"
          echo "📊 Deployment stats:"
          echo "- Repository: ${{ github.repository }}"
          echo "- Branch: ${{ github.ref_name }}"
          echo "- Commit: ${{ github.sha }}"
          echo "- Actor: ${{ github.actor }}"

      - name: 📧 Success notification
        if: success()
        run: |
          echo "🎉 Deployment successful!"
          echo "Your Excel Web Editor has been deployed successfully."

      - name: 🚨 Failure analysis
        if: failure()
        run: |
          echo "❌ All deployment methods failed!"
          echo "🔍 Troubleshooting suggestions:"
          echo "1. Check FTP server status: ${{ secrets.ftp_server }}"
          echo "2. Verify credentials are correct"
          echo "3. Check if server supports passive mode"
          echo "4. Try connecting manually to verify server availability"
          echo "5. Consider contacting hosting provider"
          echo ""
          echo "💡 Alternative deployment methods to try:"
          echo "- Use SFTP if available (port 22)"
          echo "- Use cPanel File Manager"
          echo "- Use hosting provider's deployment tools"

      - name: 📝 Create deployment report
        if: always()
        run: |
          echo "# 📊 Deployment Report" > deployment-report.md
          echo "" >> deployment-report.md
          echo "**Date:** $(date)" >> deployment-report.md
          echo "**Repository:** ${{ github.repository }}" >> deployment-report.md
          echo "**Branch:** ${{ github.ref_name }}" >> deployment-report.md
          echo "**Commit:** ${{ github.sha }}" >> deployment-report.md
          echo "**Status:** ${{ job.status }}" >> deployment-report.md
          echo "**Server:** ${{ secrets.ftp_server }}" >> deployment-report.md
          echo "" >> deployment-report.md
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ **Result:** Deployment completed successfully!" >> deployment-report.md
          else
            echo "❌ **Result:** Deployment failed. Check logs for details." >> deployment-report.md
          fi

  # Job separato per testare la connettività
  connectivity-test:
    name: 🔌 Test Server Connectivity
    runs-on: ubuntu-latest
    steps:
      - name: 🏓 Ping server
        run: |
          echo "Testing connectivity to ${{ secrets.ftp_server }}"
          ping -c 4 ${{ secrets.ftp_server }} || echo "Ping failed, but server might still be accessible"

      - name: 🔍 Check FTP port
        run: |
          echo "Testing FTP port 21 connectivity"
          timeout 10 bash -c "</dev/tcp/${{ secrets.ftp_server }}/21" || echo "FTP port 21 not accessible"

      - name: 🔍 Check SFTP port
        run: |
          echo "Testing SFTP port 22 connectivity"
          timeout 10 bash -c "</dev/tcp/${{ secrets.ftp_server }}/22" || echo "SFTP port 22 not accessible"

  # Job per pulizia cache in caso di problemi persistenti
  cache-cleanup:
    name: 🧹 Cache Cleanup
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Clear GitHub Actions cache
        run: |
          echo "If deployments keep failing, consider clearing the FTP sync state"
          echo "This will force a complete re-upload on next deployment"