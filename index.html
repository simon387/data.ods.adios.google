<!DOCTYPE html>
<html lang="it">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Excel Web Editor</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: Arial, sans-serif;
			background: #f5f5f5;
		}

		.header {
			background: #2c5aa0;
			color: white;
			padding: 1rem;
			display: flex;
			justify-content: space-between;
			align-items: center;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}

		.controls {
			display: flex;
			gap: 10px;
		}

		button {
			background: #4a69bd;
			color: white;
			border: none;
			padding: 8px 16px;
			border-radius: 4px;
			cursor: pointer;
			transition: background 0.3s;
		}

		button:hover {
			background: #3c5aa6;
		}

		.file-input {
			display: none;
		}

		.container {
			padding: 20px;
			max-width: 100%;
			overflow: auto;
		}

		.spreadsheet {
			background: white;
			border-radius: 8px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			overflow: hidden;
		}

		.sheet-tabs {
			background: #f8f9fa;
			padding: 10px;
			border-bottom: 1px solid #ddd;
		}

		.sheet-tab {
			display: inline-block;
			padding: 8px 16px;
			background: #e9ecef;
			margin-right: 5px;
			border-radius: 4px 4px 0 0;
			cursor: pointer;
			border: 1px solid #ddd;
			border-bottom: none;
		}

		.sheet-tab.active {
			background: white;
			font-weight: bold;
		}

		.grid-container {
			overflow: auto;
			max-height: 600px;
		}

		table {
			border-collapse: collapse;
			width: 100%;
		}

		th, td {
			border: 1px solid #ddd;
			padding: 4px 8px;
			min-width: 100px;
			position: relative;
		}

		th {
			background: #f8f9fa;
			font-weight: bold;
			text-align: center;
		}

		.row-header {
			background: #f8f9fa;
			font-weight: bold;
			text-align: center;
			min-width: 50px;
		}

		.cell {
			min-height: 20px;
			cursor: cell;
			transition: background 0.2s;
		}

		.cell:hover {
			background: #f0f7ff;
		}

		.cell.selected {
			background: #d4edda !important;
			outline: 2px solid #28a745;
		}

		.cell input {
			width: 100%;
			border: none;
			background: transparent;
			padding: 4px;
			font-family: inherit;
		}

		.status {
			position: fixed;
			bottom: 20px;
			right: 20px;
			padding: 10px 20px;
			border-radius: 4px;
			color: white;
			opacity: 0;
			transition: opacity 0.3s;
		}

		.status.show {
			opacity: 1;
		}

		.status.success {
			background: #28a745;
		}

		.status.error {
			background: #dc3545;
		}

		.loading {
			text-align: center;
			padding: 40px;
			color: #666;
		}
	</style>
</head>
<body>
<div class="header">
	<h1>Excel Web Editor</h1>
	<div class="controls">
		<button onclick="document.getElementById('file-upload').click()">
			üìÅ Carica Excel
		</button>
		<input type="file" id="file-upload" class="file-input" accept=".xlsx,.xls" onchange="loadFile(event)">
		<button onclick="saveData()" id="save-btn">üíæ Salva</button>
		<button onclick="exportExcel()">üì§ Esporta Excel</button>
		<button onclick="createNewSheet()">‚ûï Nuovo Foglio</button>
	</div>
</div>

<div class="container">
	<div class="spreadsheet">
		<div class="sheet-tabs" id="sheet-tabs">
			<!-- I tab dei fogli verranno inseriti qui -->
		</div>
		<div class="grid-container">
			<div id="loading" class="loading">
				Carica un file Excel per iniziare o crea un nuovo foglio
			</div>
			<table id="spreadsheet-table" style="display: none;">
				<!-- La tabella verr√† generata dinamicamente -->
			</table>
		</div>
	</div>
</div>

<div class="status" id="status"></div>

<script>
	let workbook = null;
	let currentSheet = 0;
	let data = {};
	let selectedCell = null;
	let documentId = null;

	// Carica file Excel
	function loadFile(event) {
		const file = event.target.files[0];
		if (!file) return;

		const reader = new FileReader();
		reader.onload = function(e) {
			try {
				workbook = XLSX.read(e.target.result, { type: 'binary' });
				processWorkbook();
				showStatus('File caricato con successo!', 'success');
			} catch (error) {
				showStatus('Errore nel caricamento del file: ' + error.message, 'error');
			}
		};
		reader.readAsBinaryString(file);
	}

	// Processa il workbook Excel
	function processWorkbook() {
		data = {};
		const tabsContainer = document.getElementById('sheet-tabs');
		tabsContainer.innerHTML = '';

		workbook.SheetNames.forEach((sheetName, index) => {
			const worksheet = workbook.Sheets[sheetName];

			// Controlla se √® una tabella pivot
			const isPivot = detectPivotTable(worksheet);

			try {
				data[sheetName] = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });

				// Se la conversione restituisce dati vuoti ma il foglio non √® vuoto
				if (data[sheetName].length === 0 && worksheet['!ref']) {
					// Prova a estrarre i valori delle celle direttamente
					data[sheetName] = extractCellValues(worksheet);
				}
			} catch (error) {
				console.warn(`Errore nel processare il foglio ${sheetName}:`, error);
				data[sheetName] = [['Errore nel caricamento del foglio']];
			}

			// Crea tab per il foglio
			const tab = document.createElement('div');
			tab.className = `sheet-tab ${index === 0 ? 'active' : ''}`;
			tab.textContent = sheetName + (isPivot ? ' (Pivot)' : '');
			tab.onclick = () => switchSheet(index, sheetName);

			// Aggiungi indicatore visivo per le pivot
			if (isPivot) {
				tab.style.fontStyle = 'italic';
				tab.style.color = '#666';
				tab.title = 'Questo foglio contiene una tabella pivot';
			}

			tabsContainer.appendChild(tab);
		});

		currentSheet = 0;
		displaySheet(workbook.SheetNames[0]);
	}

	// Rileva se un foglio contiene una tabella pivot
	function detectPivotTable(worksheet) {
		// Le pivot table hanno spesso propriet√† specifiche
		if (worksheet['!pivots'] || worksheet['!tables']) {
			return true;
		}

		// Controlla le celle per indicatori di pivot table
		const range = worksheet['!ref'];
		if (!range) return false;

		const decoded = XLSX.utils.decode_range(range);
		for (let row = decoded.s.r; row <= decoded.e.r; row++) {
			for (let col = decoded.s.c; col <= decoded.e.c; col++) {
				const cellAddress = XLSX.utils.encode_cell({r: row, c: col});
				const cell = worksheet[cellAddress];
				if (cell && cell.f && cell.f.includes('PIVOT')) {
					return true;
				}
			}
		}

		return false;
	}

	// Estrae i valori delle celle direttamente
	function extractCellValues(worksheet) {
		const result = [];
		const range = worksheet['!ref'];
		if (!range) return result;

		const decoded = XLSX.utils.decode_range(range);

		for (let row = decoded.s.r; row <= decoded.e.r; row++) {
			const rowData = [];
			for (let col = decoded.s.c; col <= decoded.e.c; col++) {
				const cellAddress = XLSX.utils.encode_cell({r: row, c: col});
				const cell = worksheet[cellAddress];

				let cellValue = '';
				if (cell) {
					// Prova prima il valore formattato, poi quello raw
					cellValue = cell.w || cell.v || '';
				}

				rowData[col] = cellValue;
			}
			result[row] = rowData;
		}

		return result;
	}

	// Cambia foglio
	function switchSheet(index, sheetName) {
		currentSheet = index;

		// Aggiorna tab attivi
		document.querySelectorAll('.sheet-tab').forEach((tab, i) => {
			tab.classList.toggle('active', i === index);
		});

		displaySheet(sheetName);
	}

	// Visualizza il foglio corrente
	function displaySheet(sheetName) {
		const table = document.getElementById('spreadsheet-table');
		const loading = document.getElementById('loading');

		if (!data[sheetName]) {
			data[sheetName] = [[]];
		}

		const sheetData = data[sheetName];
		const maxCols = Math.max(26, Math.max(...sheetData.map(row => row.length)));
		const maxRows = Math.max(20, sheetData.length);

		let html = '<thead><tr><th></th>';

		// Header colonne (A, B, C, ...)
		for (let col = 0; col < maxCols; col++) {
			html += `<th>${String.fromCharCode(65 + col)}</th>`;
		}
		html += '</tr></thead><tbody>';

		// Righe dati
		for (let row = 0; row < maxRows; row++) {
			html += `<tr><th class="row-header">${row + 1}</th>`;

			for (let col = 0; col < maxCols; col++) {
				const cellValue = sheetData[row] && sheetData[row][col] ? sheetData[row][col] : '';
				html += `<td class="cell" data-row="${row}" data-col="${col}" onclick="selectCell(this)" ondblclick="editCell(this)">${cellValue}</td>`;
			}
			html += '</tr>';
		}
		html += '</tbody>';

		table.innerHTML = html;
		table.style.display = 'table';
		loading.style.display = 'none';
	}

	// Seleziona cella
	function selectCell(cell) {
		if (selectedCell) {
			selectedCell.classList.remove('selected');
		}
		selectedCell = cell;
		cell.classList.add('selected');
	}

	// Modifica cella
	function editCell(cell) {
		const currentValue = cell.textContent;
		const input = document.createElement('input');
		input.type = 'text';
		input.value = currentValue;

		input.onblur = function() {
			finishEdit(cell, input.value);
		};

		input.onkeydown = function(e) {
			if (e.key === 'Enter') {
				finishEdit(cell, input.value);
			} else if (e.key === 'Escape') {
				finishEdit(cell, currentValue);
			}
		};

		cell.innerHTML = '';
		cell.appendChild(input);
		input.focus();
		input.select();
	}

	// Completa modifica
	function finishEdit(cell, newValue) {
		const row = parseInt(cell.dataset.row);
		const col = parseInt(cell.dataset.col);
		const sheetName = workbook.SheetNames[currentSheet];

		// Aggiorna i dati
		if (!data[sheetName][row]) {
			data[sheetName][row] = [];
		}
		data[sheetName][row][col] = newValue;

		cell.innerHTML = newValue;

		// Auto-save dopo 1 secondo
		clearTimeout(window.saveTimeout);
		window.saveTimeout = setTimeout(() => {
			saveData();
		}, 1000);
	}

	// Crea nuovo foglio
	function createNewSheet() {
		if (!workbook) {
			workbook = XLSX.utils.book_new();
			data = {};
		}

		const sheetName = `Foglio${Object.keys(data).length + 1}`;
		data[sheetName] = [[]];
		workbook.SheetNames.push(sheetName);
		workbook.Sheets[sheetName] = XLSX.utils.aoa_to_sheet([[]]);

		// Aggiorna UI
		const tabsContainer = document.getElementById('sheet-tabs');
		const tab = document.createElement('div');
		tab.className = 'sheet-tab';
		tab.textContent = sheetName;
		tab.onclick = () => switchSheet(workbook.SheetNames.length - 1, sheetName);
		tabsContainer.appendChild(tab);

		switchSheet(workbook.SheetNames.length - 1, sheetName);
	}

	// Salva dati su server
	async function saveData() {
		if (!workbook || Object.keys(data).length === 0) {
			showStatus('Nessun dato da salvare', 'error');
			return;
		}

		try {
			const saveBtn = document.getElementById('save-btn');
			saveBtn.textContent = 'üíæ Salvando...';
			saveBtn.disabled = true;

			const response = await fetch('excel_backend.php', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					action: 'save',
					documentId: documentId,
					data: data,
					sheetNames: workbook.SheetNames
				})
			});

			const result = await response.json();

			if (result.success) {
				if (!documentId) {
					documentId = result.documentId;
				}
				showStatus('Dati salvati con successo!', 'success');
			} else {
				showStatus('Errore nel salvataggio: ' + result.message, 'error');
			}
		} catch (error) {
			showStatus('Errore di connessione: ' + error.message, 'error');
		} finally {
			const saveBtn = document.getElementById('save-btn');
			saveBtn.textContent = 'üíæ Salva';
			saveBtn.disabled = false;
		}
	}

	// Esporta in Excel
	function exportExcel() {
		if (!workbook) {
			showStatus('Nessun dato da esportare', 'error');
			return;
		}

		// Aggiorna il workbook con i dati correnti
		Object.keys(data).forEach(sheetName => {
			workbook.Sheets[sheetName] = XLSX.utils.aoa_to_sheet(data[sheetName]);
		});

		const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'binary' });

		function s2ab(s) {
			const buf = new ArrayBuffer(s.length);
			const view = new Uint8Array(buf);
			for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
			return buf;
		}

		const blob = new Blob([s2ab(wbout)], { type: "application/octet-stream" });
		const url = URL.createObjectURL(blob);

		const a = document.createElement('a');
		a.href = url;
		a.download = `documento_${new Date().toISOString().split('T')[0]}.xlsx`;
		document.body.appendChild(a);
		a.click();
		document.body.removeChild(a);
		URL.revokeObjectURL(url);

		showStatus('File esportato con successo!', 'success');
	}

	// Mostra messaggio di stato
	function showStatus(message, type) {
		const status = document.getElementById('status');
		status.textContent = message;
		status.className = `status ${type} show`;

		setTimeout(() => {
			status.classList.remove('show');
		}, 3000);
	}

	// Carica dati esistenti all'avvio
	window.onload = async function() {
		try {
			const response = await fetch('excel_backend.php?action=load');
			const result = await response.json();

			if (result.success && result.data) {
				documentId = result.documentId;
				data = result.data;
				workbook = XLSX.utils.book_new();

				result.sheetNames.forEach(sheetName => {
					workbook.SheetNames.push(sheetName);
					workbook.Sheets[sheetName] = XLSX.utils.aoa_to_sheet(data[sheetName] || []);
				});

				processWorkbook();
				showStatus('Dati caricati dal server', 'success');
			}
		} catch (error) {
			console.log('Nessun dato esistente da caricare');
		}
	};
</script>
</body>
</html>